<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BLE Motor RPM Control</title>
  <style>
    body { font-family: sans-serif; margin: 30px; }
    h1 { color: #333; }
    button { padding: 10px 20px; margin: 5px; }
    input { padding: 5px; width: 80px; }
    .status { margin-top: 10px; color: #d13a30; }
  </style>
</head>
<body>
  <h1>BLE Motor RPM Control</h1>

  <p>
    <button id="connectBleButton">Connect to ESP32</button>
    <button id="disconnectBleButton">Disconnect</button>
  </p>

  <p>
    Set RPM: <input type="number" id="rpmInput" value="150">
    <button id="sendButton">Send to ESP32</button>
  </p>

  <p>Current RPM: <strong><span id="currentRPM">---</span></strong></p>
  <p class="status" id="bleState">Disconnected</p>

  <script>
    const connectButton = document.getElementById('connectBleButton');
    const disconnectButton = document.getElementById('disconnectBleButton');
    const sendButton = document.getElementById('sendButton');
    const rpmInput = document.getElementById('rpmInput');
    const currentRPM = document.getElementById('currentRPM');
    const bleState = document.getElementById('bleState');

    const deviceName = 'ESP32-BLE-Motor';
    const bleService = '19b10000-e8f2-537e-4f6c-d104768a1214';
    const rxCharUUID = '19b10002-e8f2-537e-4f6c-d104768a1214'; // Write
    const txCharUUID = '19b10001-e8f2-537e-4f6c-d104768a1214'; // Notify

    let bleServer, service, txChar, rxChar;

    connectButton.addEventListener('click', async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: deviceName }],
          optionalServices: [bleService]
        });
        bleState.textContent = `Connecting to ${device.name}...`;

        device.addEventListener('gattservicedisconnected', onDisconnected);

        const server = await device.gatt.connect();
        service = await server.getPrimaryService(bleService);

        rxChar = await service.getCharacteristic(rxCharUUID);
        txChar = await service.getCharacteristic(txCharUUID);
        await txChar.startNotifications();
        txChar.addEventListener('characteristicvaluechanged', handleNotify);

        bleState.textContent = `Connected to ${device.name}`;
        bleState.style.color = '#24af37';
      } catch (error) {
        console.error(error);
        bleState.textContent = 'Connection failed';
      }
    });

    sendButton.addEventListener('click', async () => {
      if (!rxChar) return alert('Not connected to ESP32');
      const rpm = rpmInput.value;
      const data = new TextEncoder().encode('S' + rpm);
      await rxChar.writeValue(data);
    });

    function handleNotify(event) {
      const value = new TextDecoder().decode(event.target.value);
      if (value.startsWith('R')) {
        currentRPM.textContent = value.substring(1);
      }
    }

    disconnectButton.addEventListener('click', () => {
      if (bleServer && bleServer.connected) bleServer.disconnect();
    });

    function onDisconnected(event) {
      bleState.textContent = 'Disconnected';
      bleState.style.color = '#d13a30';
      currentRPM.textContent = '---';
    }
  </script>
</body>
</html>
